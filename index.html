<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ivan Seredkin's journey around the world">
    <title>Ivan Seredkin</title>

    <!-- Social Media Preview Meta Tags -->
    <meta property="og:title" content="Ivan Seredkin's Journey">
    <meta property="og:description" content="Explore Ivan's journey around the world">
    <meta property="og:image" content="https://siropkin.github.io/preview.png">
    <meta property="og:url" content="https://siropkin.github.io/">
    <meta property="og:type" content="website">

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ivan Seredkin's Journey">
    <meta name="twitter:description" content="Explore Ivan's journey around the world">
    <meta name="twitter:image" content="https://siropkin.github.io/preview.png">

    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script>
      // Data
      window.locations = [
        {
          country: "Russia",
          city: "Chaykovsky",
          coordinates: [54.1277, 56.7661],
          startDate: new Date(1985, 8, 19),
          endDate: new Date(2005, 9, 1),
          description: "Born to code"
        },
        {
          country: "Russia",
          city: "Izhevsk",
          coordinates: [53.2324, 56.8619],
          startDate: new Date(2005, 9, 1),
          endDate: new Date(2014, 3, 1),
          description: "Pelmeni & textbooks"
        },
        {
          country: "Russia",
          city: "Moscow",
          coordinates: [37.6173, 55.7558],
          startDate: new Date(2014, 3, 1),
          endDate: new Date(2020, 4, 1),
          description: "Subway warrior"
        },
        {
          country: "Russia",
          city: "Saint Petersburg",
          coordinates: [30.3609, 59.9311],
          startDate: new Date(2020, 4, 1),
          endDate: new Date(2022, 2, 4),
          description: "White nights, cold bytes"
        },
        {
          country: "Turkey",
          city: "Antalya",
          coordinates: [30.7133, 36.8969],
          startDate: new Date(2022, 2, 4),
          endDate: new Date(2023, 10, 23),
          description: "Beach office vibes"
        },
        {
          country: "USA",
          city: "Annapolis",
          coordinates: [-76.4896, 38.9764],
          startDate: new Date(2023, 10, 23),
          endDate: null,
          description: "American debugger"
        }
      ];
    </script>
</head>
<body>
<header>
    <h1>Hi! I'm Ivan ðŸ‘‹</h1>
</header>

<main>
    <section id="journey">
        <p>And this is my journey around the world:</p>
        <div id="map-container" style="position: relative; width: 100%;">
            <canvas id="map"></canvas>
            <div id="tooltip" style="position: absolute; display: none; background: #fff"></div>
        </div>
    </section>
</main>

<footer>
    <p>My digital coordinates:</p>
    <ul>
        <li><a href="https://www.linkedin.com/in/ivanseredkin" target="_blank">LinkedIn</a></li>
        <li><a href="https://github.com/siropkin" target="_blank">GitHub</a></li>
        <li><a id="email" href="#"></a></li>
    </ul>
</footer>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const emailUser = 'ivan.seredkin';
    const emailDomain = 'gmail.com';
    const emailAddress = `${emailUser}@${emailDomain}`;
    const emailLink = document.getElementById('email');
    emailLink.href = `mailto:${emailAddress}`;
    emailLink.textContent = 'Email';
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log("Hello, World! ðŸŒ");

    // Format date function
    function formatDate(date) {
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
      });
    }

    // Calculate duration in days
    function getDurationInDays(startDate, endDate) {
      const end = endDate instanceof Date ? endDate : new Date();
      return Math.ceil(Math.abs(end - startDate) / (1000 * 60 * 60 * 24));
    }

    // Format duration
    function formatDuration(startDate, endDate) {
      const duration = getDurationInDays(startDate, endDate);
      const years = Math.floor(duration / 365);
      const months = Math.floor((duration % 365) / 30);
      return `${years > 0 ? years + ' year' + (years > 1 ? 's ' : ' ') : ''}${months > 0 ? months + ' month' + (months > 1 ? 's' : '') : ''}`;
    }

    // Calculate radius based on all data and scale of all data
    function getRadius(startDate, endDate) {
      const durations = window.locations.map(location =>
        getDurationInDays(location.startDate, location.endDate)
      );
      const minDuration = Math.min(...durations);
      const maxDuration = Math.max(...durations);
      const currentDuration = getDurationInDays(startDate, endDate);

      // Larger sizes for mobile devices
      const minRadius = isMobileDevice() ? 12 : 6;
      const maxRadius = isMobileDevice() ? 30 : 20;
      return minRadius + ((currentDuration - minDuration) / (maxDuration - minDuration)) * (maxRadius - minRadius);
    }

    // Check if device is mobile
    function isMobileDevice() {
      return window.innerWidth <= 768;
    }

    // Setup canvas
    const container = document.getElementById('map-container');
    const canvas = document.getElementById('map');
    const tooltip = document.getElementById('tooltip');

    // Create projection for the whole world
    function createProjection(width, height) {
      // Calculate the center of your journey points
      const longitudes = window.locations.map(loc => loc.coordinates[0]);
      const latitudes = window.locations.map(loc => loc.coordinates[1]);

      const centerLon = (Math.min(...longitudes) + Math.max(...longitudes)) / 2;
      const centerLat = (Math.min(...latitudes) + Math.max(...latitudes)) / 2;

      // Use a larger scale (more zoomed in) for mobile devices
      const scaleFactor = isMobileDevice() ? 3.5 : 6.5;

      // Create a projection that shows the whole world
      // but is centered on your journey's center point
      return d3.geoMercator()
        .center([centerLon, centerLat])
        .scale(width / scaleFactor) // Higher scale (lower divisor) for mobile devices
        .translate([width / 2, height / 2]);
    }

    // Set canvas dimensions
    function resizeCanvas() {
      // Calculate all non-map elements height
      const headerHeight = document.querySelector('header').offsetHeight;
      const paragraphHeight = document.querySelector('#journey p').offsetHeight;
      const footerHeight = document.querySelector('footer').offsetHeight;

      // Add some buffer for margins and padding
      const buffer = 100;

      // Calculate available height
      const availableHeight = window.innerHeight - headerHeight - paragraphHeight - footerHeight - buffer;

      // Apply calculated height for all devices
      container.style.height = `${availableHeight}px`;

      const devicePixelRatio = window.devicePixelRatio || 1;
      canvas.width = container.clientWidth * devicePixelRatio;
      canvas.height = container.clientHeight * devicePixelRatio;
      canvas.style.width = container.clientWidth + 'px';
      canvas.style.height = container.clientHeight + 'px';

      // Redraw map when resized
      drawMap();
    }

    // Initial resize and add event listener
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Draw map function
    function drawMap() {
      const context = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;

      // Clear canvas
      context.clearRect(0, 0, width, height);

      // Create projection for the whole world
      const projection = createProjection(width, height);

      const path = d3.geoPath()
        .projection(projection)
        .context(context);

      // Load world map data
      d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
        .then(function (world) {
          // Draw countries
          context.beginPath();
          path(topojson.feature(world, world.objects.countries));
          context.fillStyle = '#fff';
          context.fill();

          // Draw country borders
          context.beginPath();
          path(topojson.mesh(world, world.objects.countries));
          context.strokeStyle = '#000';
          context.lineWidth = 0.5;
          context.stroke();

          // Draw journey points
          window.locations.forEach(function (location) {
            const [x, y] = projection(location.coordinates);
            const radius = getRadius(location.startDate, location.endDate);

            // Draw point
            context.beginPath();
            context.arc(x, y, radius, 0, 2 * Math.PI);
            context.fillStyle = '#000';
            context.fill();
            context.strokeStyle = '#fff';
            context.lineWidth = 1;
            context.stroke();
          });
        });
    }

    // Show tooltip function
    function showTooltip(location, clientX, clientY, rect) {
      const startDateStr = formatDate(location.startDate);
      const endDateStr = location.endDate instanceof Date ? formatDate(location.endDate) : 'Present';
      const durationStr = formatDuration(location.startDate, location.endDate);

      tooltip.innerHTML = `
        <strong>${location.city}, ${location.country}</strong><br>
        <small>${startDateStr} - ${endDateStr}</small><br>
        <small>${durationStr}</small><br>
        <small>${location.description}</small><br>
      `;

      tooltip.style.display = 'block';
      tooltip.style.left = (clientX - rect.left + 10) + 'px';
      tooltip.style.top = (clientY - rect.top + 10) + 'px';

      // Adjust tooltip position if it goes off screen
      const tooltipRect = tooltip.getBoundingClientRect();
      if (tooltipRect.right > window.innerWidth) {
        tooltip.style.left = (clientX - rect.left - tooltipRect.width - 10) + 'px';
      }
      if (tooltipRect.bottom > window.innerHeight) {
        tooltip.style.top = (clientY - rect.top - tooltipRect.height - 10) + 'px';
      }
    }

    // Hide tooltip function
    function hideTooltip() {
      tooltip.style.display = 'none';
    }

    // Handle mouse events for tooltip
    canvas.addEventListener('mousemove', function (event) {
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      // Create projection for the whole world
      const projection = createProjection(canvas.width, canvas.height);

      // Check if mouse is over any point
      let hoveredLocation = null;

      window.locations.forEach(function (location) {
        const [pointX, pointY] = projection(location.coordinates);
        const radius = getRadius(location.startDate, location.endDate);

        const distance = Math.sqrt(Math.pow(x * window.devicePixelRatio - pointX, 2) +
          Math.pow(y * window.devicePixelRatio - pointY, 2));

        if (distance <= radius) {
          hoveredLocation = location;
        }
      });

      // Show or hide tooltip
      if (hoveredLocation) {
        showTooltip(hoveredLocation, event.clientX, event.clientY, rect);
      } else {
        hideTooltip();
      }
    });
    canvas.addEventListener('mouseleave', function () {
      hideTooltip();
    });

    // Add touch events for mobile
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);

    // Handle touch events
    function handleTouch(event) {
      event.preventDefault(); // Prevent scrolling when touching the canvas

      if (event.touches.length > 0) {
        const touch = event.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        // Use a larger detection radius for touch events
        const extraTouchRadius = isMobileDevice() ? 15 : 0;

        // Create projection for the whole world
        const projection = createProjection(canvas.width, canvas.height);

        // Check if touch is over any point
        let touchedLocation = null;

        window.locations.forEach(function (location) {
          const [pointX, pointY] = projection(location.coordinates);
          const radius = getRadius(location.startDate, location.endDate) + extraTouchRadius;

          const distance = Math.sqrt(Math.pow(x * window.devicePixelRatio - pointX, 2) +
            Math.pow(y * window.devicePixelRatio - pointY, 2));

          if (distance <= radius) {
            touchedLocation = location;
          }
        });

        // Show or hide tooltip
        if (touchedLocation) {
          showTooltip(touchedLocation, touch.clientX, touch.clientY, rect);
        } else {
          hideTooltip();
        }
      }
    }

    // Initial draw
    drawMap();
  });
</script>
</body>
</html>
